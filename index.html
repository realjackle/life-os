<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Life OS</title>
  
  <!-- PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Life OS">
  <meta name="theme-color" content="#000000">
  
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESET & VARIABLES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #000;
      --surface: #111;
      --surface-2: #1a1a1a;
      --border: rgba(255,255,255,0.08);
      --text: #fff;
      --text-secondary: rgba(255,255,255,0.6);
      --text-tertiary: rgba(255,255,255,0.3);
      --accent: #0A84FF;
      --green: #30D158;
      --orange: #FF9F0A;
      --red: #FF453A;
      --purple: #BF5AF2;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       APP SHELL - Fixed viewport layout
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .app {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* Top Bar */
    .topbar {
      flex-shrink: 0;
      height: 48px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .topbar-logo {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .topbar-logo span {
      color: var(--accent);
    }

    .topbar-time {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .topbar-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.15s;
    }

    .topbar-btn:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }

    .topbar-btn.primary {
      background: var(--accent);
      color: white;
      width: auto;
      padding: 0 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .topbar-btn.primary:hover {
      background: #0070E0;
    }

    /* Main Layout */
    .main {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-height: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SIDEBAR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sidebar {
      width: 280px;
      flex-shrink: 0;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .sidebar-scroll::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar-scroll::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
    }

    /* Sidebar Sections */
    .sidebar-section {
      margin-bottom: 20px;
    }

    .sidebar-section:last-child {
      margin-bottom: 0;
    }

    .section-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      padding-left: 2px;
    }

    /* North Star */
    .north-star-card {
      background: linear-gradient(135deg, rgba(191,90,242,0.15), rgba(10,132,255,0.15));
      border: 1px solid rgba(191,90,242,0.2);
      border-radius: 12px;
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .north-star-card:hover {
      border-color: rgba(191,90,242,0.4);
    }

    .north-star-icon {
      font-size: 12px;
      margin-bottom: 6px;
    }

    .north-star-text {
      font-size: 13px;
      color: var(--text-secondary);
      font-style: italic;
      line-height: 1.5;
    }

    .north-star-text.empty {
      color: var(--text-tertiary);
      font-style: normal;
    }

    /* Goals */
    .goal-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: var(--surface-2);
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .goal-item:hover {
      background: rgba(255,255,255,0.08);
    }

    .goal-item:last-child {
      margin-bottom: 0;
    }

    .goal-num {
      font-size: 11px;
      font-weight: 700;
      color: var(--purple);
      min-width: 16px;
    }

    .goal-text {
      font-size: 13px;
      flex: 1;
    }

    .goal-add {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      color: var(--text-tertiary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .goal-add:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Progress Card */
    .progress-card {
      background: var(--surface-2);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .progress-ring-wrap {
      position: relative;
      width: 64px;
      height: 64px;
      flex-shrink: 0;
    }

    .progress-ring {
      transform: rotate(-90deg);
    }

    .progress-ring-bg {
      fill: none;
      stroke: rgba(255,255,255,0.1);
      stroke-width: 6;
    }

    .progress-ring-fill {
      fill: none;
      stroke: var(--accent);
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.6s ease;
    }

    .progress-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 16px;
      font-weight: 600;
    }

    .progress-info {
      flex: 1;
      min-width: 0;
    }

    .progress-label {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-bottom: 4px;
    }

    .progress-delta {
      font-size: 18px;
      font-weight: 600;
    }

    .progress-delta.positive { color: var(--green); }
    .progress-delta.negative { color: var(--red); }
    .progress-delta.neutral { color: var(--text-tertiary); }

    .progress-sub {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    /* Focus */
    .focus-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--surface-2);
      border-radius: 8px;
      margin-bottom: 6px;
    }

    .focus-item:last-child {
      margin-bottom: 0;
    }

    .focus-icon {
      font-size: 14px;
    }

    .focus-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
    }

    .focus-progress {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    /* Attention */
    .attention-section {
      background: rgba(255,69,58,0.08);
      border: 1px solid rgba(255,69,58,0.15);
      border-radius: 12px;
      padding: 12px;
    }

    .attention-section .section-label {
      color: var(--red);
    }

    .attention-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      font-size: 12px;
    }

    .attention-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .attention-rank {
      color: var(--red);
      font-weight: 600;
      min-width: 16px;
    }

    .attention-name {
      flex: 1;
    }

    .attention-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(255,69,58,0.2);
      color: var(--red);
    }

    /* Stats */
    .stats-row {
      display: flex;
      gap: 8px;
    }

    .stat-chip {
      flex: 1;
      background: var(--surface-2);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONTENT AREA
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    /* Content Header */
    .content-header {
      flex-shrink: 0;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }

    .search-box {
      flex: 1;
      max-width: 300px;
      position: relative;
    }

    .search-input {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px 8px 32px;
      color: var(--text);
      font-size: 13px;
      transition: all 0.15s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--surface-2);
    }

    .search-input::placeholder {
      color: var(--text-tertiary);
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-tertiary);
      font-size: 12px;
    }

    .search-hint {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: var(--text-tertiary);
      background: rgba(255,255,255,0.08);
      padding: 2px 5px;
      border-radius: 3px;
      font-family: monospace;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 12px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .filter-btn:hover {
      border-color: rgba(255,255,255,0.2);
      color: var(--text);
    }

    .filter-btn.active {
      background: var(--text);
      border-color: var(--text);
      color: var(--bg);
    }

    /* Content Scroll */
    .content-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      min-height: 0;
    }

    .content-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .content-scroll::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
    }

    .content-scroll::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.2);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SYSTEM CARDS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .systems-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .system-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.15s;
    }

    .system-card:hover {
      border-color: rgba(255,255,255,0.12);
    }

    .system-header {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      gap: 12px;
      cursor: pointer;
    }

    .system-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .system-info {
      flex: 1;
      min-width: 0;
    }

    .system-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .system-name {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .system-edit-btn {
      opacity: 0;
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 11px;
      cursor: pointer;
      padding: 2px;
      transition: all 0.15s;
    }

    .system-header:hover .system-edit-btn {
      opacity: 1;
    }

    .system-edit-btn:hover {
      color: var(--accent);
    }

    .system-meta-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .system-badge {
      font-size: 10px;
      font-weight: 500;
      padding: 3px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .system-badge:hover {
      filter: brightness(1.2);
    }

    .system-badge.running {
      background: rgba(48,209,88,0.15);
      color: var(--green);
    }

    .system-badge.rework {
      background: rgba(255,159,10,0.15);
      color: var(--orange);
    }

    .system-badge.struggle {
      background: rgba(255,69,58,0.15);
      color: var(--red);
    }

    .system-badge.backlog {
      background: rgba(142,142,147,0.15);
      color: #8E8E93;
    }

    .system-feature-count {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .system-progress-bar {
      flex: 1;
      max-width: 80px;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
    }

    .system-progress-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .system-progress-text {
      font-size: 12px;
      font-weight: 600;
      min-width: 36px;
      text-align: right;
    }

    .system-chevron {
      color: var(--text-tertiary);
      font-size: 12px;
      transition: transform 0.2s;
    }

    .system-card.expanded .system-chevron {
      transform: rotate(180deg);
    }

    /* Features */
    .system-features {
      display: none;
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      background: rgba(0,0,0,0.2);
    }

    .system-card.expanded .system-features {
      display: block;
    }

    .feature-row {
      display: flex;
      align-items: center;
      padding: 10px 0;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .feature-row:last-of-type {
      border-bottom: none;
    }

    .feature-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.15s;
      flex-shrink: 0;
    }

    .feature-status.active {
      background: var(--green);
    }

    .feature-status.planned {
      background: rgba(255,255,255,0.2);
    }

    .feature-status:hover {
      transform: scale(1.3);
    }

    .feature-name-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }

    .feature-name {
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .feature-name.planned {
      color: var(--text-secondary);
    }

    .feature-edit-btn {
      opacity: 0;
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 10px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .feature-row:hover .feature-edit-btn {
      opacity: 1;
    }

    .feature-edit-btn:hover {
      color: var(--accent);
    }

    .feature-level {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .feature-level-text {
      font-size: 10px;
      color: var(--text-tertiary);
      min-width: 28px;
    }

    .level-dots {
      display: flex;
      gap: 4px;
    }

    .level-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      cursor: pointer;
      transition: all 0.15s;
    }

    .level-dot.filled {
      background: var(--accent);
    }

    .level-dot:hover {
      transform: scale(1.4);
    }

    .feature-delete {
      opacity: 0;
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
      padding: 0 4px;
    }

    .feature-row:hover .feature-delete {
      opacity: 1;
    }

    .feature-delete:hover {
      color: var(--red);
    }

    /* Add Feature */
    .add-feature-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .add-feature-input {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--text);
      font-size: 12px;
    }

    .add-feature-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .add-feature-btn {
      background: var(--accent);
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      color: white;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .add-feature-btn:hover {
      background: #0070E0;
    }

    .add-feature-btn:disabled {
      background: rgba(255,255,255,0.1);
      color: var(--text-tertiary);
      cursor: not-allowed;
    }

    /* Delete System */
    .delete-system-row {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
    }

    .delete-system-btn {
      background: none;
      border: 1px solid rgba(255,69,58,0.3);
      border-radius: 6px;
      padding: 6px 12px;
      color: rgba(255,69,58,0.6);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .delete-system-btn:hover {
      border-color: var(--red);
      color: var(--red);
      background: rgba(255,69,58,0.1);
    }

    /* Add System Button */
    .add-system-btn {
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 20px;
      color: var(--text-tertiary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .add-system-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MODALS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%;
      max-width: 480px;
      max-height: 85vh;
      overflow: hidden;
      transform: scale(0.95);
      transition: transform 0.2s;
    }

    .modal-overlay.visible .modal {
      transform: scale(1);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 17px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      max-height: calc(85vh - 140px);
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .modal-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .modal-btn.secondary {
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--text);
    }

    .modal-btn.secondary:hover {
      background: rgba(255,255,255,0.15);
    }

    .modal-btn.primary {
      background: var(--accent);
      border: none;
      color: white;
    }

    .modal-btn.primary:hover {
      background: #0070E0;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 14px;
      transition: all 0.15s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* Command Palette */
    .command-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 15vh;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.15s;
    }

    .command-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .command-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .command-input-wrap {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      gap: 10px;
      border-bottom: 1px solid var(--border);
    }

    .command-input-icon {
      color: var(--text-tertiary);
      font-size: 14px;
    }

    .command-input {
      flex: 1;
      background: none;
      border: none;
      color: var(--text);
      font-size: 15px;
      outline: none;
    }

    .command-input::placeholder {
      color: var(--text-tertiary);
    }

    .command-results {
      max-height: 300px;
      overflow-y: auto;
    }

    .command-group {
      padding: 8px 0;
    }

    .command-group-label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 4px 16px 8px;
    }

    .command-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.1s;
    }

    .command-item:hover,
    .command-item.selected {
      background: rgba(255,255,255,0.05);
    }

    .command-item-icon {
      font-size: 14px;
      width: 20px;
      text-align: center;
    }

    .command-item-text {
      flex: 1;
      font-size: 13px;
    }

    .command-item-hint {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .command-footer {
      padding: 10px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 16px;
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .command-footer kbd {
      background: rgba(255,255,255,0.1);
      padding: 1px 5px;
      border-radius: 3px;
      font-family: monospace;
      margin-right: 4px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 13px;
      z-index: 3000;
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SETUP SCREEN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .setup {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .setup-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .setup-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .setup-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .setup-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .setup-input {
      width: 100%;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 16px;
    }

    .setup-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .setup-btn {
      width: 100%;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      padding: 12px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .setup-btn:hover {
      background: #0070E0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }

      .content-header {
        flex-wrap: wrap;
      }

      .search-box {
        max-width: 100%;
        order: -1;
        width: 100%;
        margin-bottom: 8px;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       UTILITIES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="app">
    <!-- SETUP SCREEN -->
    <div class="setup" id="setup">
      <div class="setup-card">
        <div class="setup-icon">â—</div>
        <div class="setup-title">Life OS Setup</div>
        <div class="setup-text">
          Enter your Google Apps Script URL to connect your dashboard with Google Sheets.
        </div>
        <input type="text" class="setup-input" id="apiInput" placeholder="https://script.google.com/...">
        <button class="setup-btn" onclick="saveApiUrl()">Connect</button>
      </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-main hidden" id="appMain">
      <!-- Top Bar -->
      <div class="topbar">
        <div class="topbar-left">
          <div class="topbar-logo"><span>â—</span> Life OS</div>
          <div class="topbar-time" id="topbarTime"></div>
        </div>
        <div class="topbar-actions">
          <button class="topbar-btn" onclick="loadData()" title="Refresh (R)">â†»</button>
          <button class="topbar-btn" onclick="openCommandPalette()" title="Commands (âŒ˜K)">âŒ˜</button>
          <button class="topbar-btn primary" onclick="openReviewModal()">Review</button>
        </div>
      </div>

      <!-- Main Layout -->
      <div class="main">
        <!-- Sidebar -->
        <div class="sidebar">
          <div class="sidebar-scroll">
            <!-- North Star -->
            <div class="sidebar-section">
              <div class="section-label">â˜… North Star</div>
              <div class="north-star-card" onclick="editNorthStar()">
                <div class="north-star-text" id="northStarText">Define your purpose...</div>
              </div>
            </div>

            <!-- Quarterly Goals -->
            <div class="sidebar-section">
              <div class="section-label">â—† Q<span id="currentQuarter">1</span> Goals</div>
              <div id="goalsList"></div>
            </div>

            <!-- Progress -->
            <div class="sidebar-section">
              <div class="section-label">Progress</div>
              <div class="progress-card">
                <div class="progress-ring-wrap">
                  <svg class="progress-ring" width="64" height="64">
                    <circle class="progress-ring-bg" cx="32" cy="32" r="26"></circle>
                    <circle class="progress-ring-fill" id="progressRing" cx="32" cy="32" r="26" 
                      stroke-dasharray="163.4" stroke-dashoffset="163.4"></circle>
                  </svg>
                  <div class="progress-value" id="progressValue">0%</div>
                </div>
                <div class="progress-info">
                  <div class="progress-label">vs. last week</div>
                  <div class="progress-delta neutral" id="progressDelta">â€“</div>
                  <div class="progress-sub" id="progressSub">Complete a weekly review</div>
                </div>
              </div>
            </div>

            <!-- Weekly Focus -->
            <div class="sidebar-section" id="focusSection" style="display: none;">
              <div class="section-label">âš¡ This Week</div>
              <div id="focusList"></div>
            </div>

            <!-- Attention -->
            <div class="sidebar-section attention-section" id="attentionSection" style="display: none;">
              <div class="section-label">âš  Attention</div>
              <div id="attentionList"></div>
            </div>

            <!-- Stats -->
            <div class="sidebar-section">
              <div class="section-label">Overview</div>
              <div class="stats-row">
                <div class="stat-chip">
                  <div class="stat-value" id="statSystems">0</div>
                  <div class="stat-label">Systems</div>
                </div>
                <div class="stat-chip">
                  <div class="stat-value" id="statFeatures">0</div>
                  <div class="stat-label">Features</div>
                </div>
                <div class="stat-chip">
                  <div class="stat-value" id="statActive">0</div>
                  <div class="stat-label">Active</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Content -->
        <div class="content">
          <div class="content-header">
            <div class="search-box">
              <span class="search-icon">ğŸ”</span>
              <input type="text" class="search-input" id="searchInput" 
                placeholder="Search systems..." onkeyup="handleSearch(event)">
              <span class="search-hint">/</span>
            </div>
            <div class="filters" id="filters"></div>
          </div>

          <div class="content-scroll">
            <div class="systems-grid" id="systemsList"></div>
            <button class="add-system-btn" onclick="openAddSystemModal()">+ Add System</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div class="command-overlay" id="commandOverlay" onclick="if(event.target===this)closeCommandPalette()">
    <div class="command-box">
      <div class="command-input-wrap">
        <span class="command-input-icon">âŒ˜</span>
        <input type="text" class="command-input" id="commandInput" 
          placeholder="Type a command..." onkeyup="handleCommandInput(event)" onkeydown="handleCommandKeydown(event)">
      </div>
      <div class="command-results" id="commandResults"></div>
      <div class="command-footer">
        <span><kbd>â†‘â†“</kbd> Navigate</span>
        <span><kbd>â†µ</kbd> Select</span>
        <span><kbd>esc</kbd> Close</span>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Add System Modal -->
  <div class="modal-overlay" id="addSystemModal" onclick="if(event.target===this)closeModal('addSystemModal')">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Add System</div>
        <button class="modal-close" onclick="closeModal('addSystemModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" class="form-input" id="newSystemName" placeholder="e.g., Morning Routine">
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <select class="form-select" id="newSystemCategory">
            <option value="Health">ğŸƒ Health</option>
            <option value="Finance">ğŸ’° Finance</option>
            <option value="Productivity">âš¡ Productivity</option>
            <option value="Assets">ğŸ  Assets</option>
            <option value="Growth">ğŸ“š Growth</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" onclick="closeModal('addSystemModal')">Cancel</button>
        <button class="modal-btn primary" onclick="addSystem()">Add System</button>
      </div>
    </div>
  </div>

  <!-- Weekly Review Modal -->
  <div class="modal-overlay" id="reviewModal" onclick="if(event.target===this)closeModal('reviewModal')">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Weekly Review</div>
        <button class="modal-close" onclick="closeModal('reviewModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ğŸ† This week's wins</label>
          <textarea class="form-textarea" id="reviewWins" placeholder="What went well?"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ”§ Struggles</label>
          <textarea class="form-textarea" id="reviewStruggles" placeholder="What was challenging?"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">âš¡ Energy level (1-10)</label>
          <input type="number" class="form-input" id="reviewEnergy" min="1" max="10" placeholder="7">
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ¯ Next week's focus (3 systems)</label>
          <select class="form-select" id="reviewFocus1"><option value="">Select system...</option></select>
          <select class="form-select" id="reviewFocus2" style="margin-top:8px"><option value="">Select system...</option></select>
          <select class="form-select" id="reviewFocus3" style="margin-top:8px"><option value="">Select system...</option></select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" onclick="closeModal('reviewModal')">Cancel</button>
        <button class="modal-btn primary" onclick="submitReview()">Save Review</button>
      </div>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let API_URL = localStorage.getItem('lifeOsApiUrl') || '';
    let data = { systems: [], features: [] };
    let expandedSystems = new Set();
    let selectedCategory = 'all';
    let searchQuery = '';

    const categoryIcons = {
      Health: 'ğŸƒ', Finance: 'ğŸ’°', Productivity: 'âš¡', Assets: 'ğŸ ', Growth: 'ğŸ“š'
    };
    const categoryColors = {
      Health: '#30D158', Finance: '#FFD60A', Productivity: '#0A84FF', Assets: '#FF9F0A', Growth: '#BF5AF2'
    };
    const statusOrder = ['Running', 'Rework', 'Struggle', 'Backlog'];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function init() {
      if (API_URL) {
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('appMain').classList.remove('hidden');
        loadData();
        updateTime();
        setInterval(updateTime, 60000);
        renderNorthStar();
        renderQuarterlyGoals();
      }
    }

    function updateTime() {
      document.getElementById('topbarTime').textContent = 
        new Date().toLocaleString('de-DE', { weekday: 'short', hour: '2-digit', minute: '2-digit' });
    }

    function saveApiUrl() {
      const url = document.getElementById('apiInput').value.trim();
      if (!url) return toast('Please enter a URL');
      localStorage.setItem('lifeOsApiUrl', url);
      API_URL = url;
      init();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadData() {
      try {
        const res = await fetch(API_URL);
        data = await res.json();
        render();
      } catch (e) {
        toast('Load failed: ' + e.message);
      }
    }

    async function apiPost(payload) {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.success) {
          toast('Saved âœ“');
          loadData();
        } else {
          throw new Error(result.error);
        }
      } catch (e) {
        toast('Error: ' + e.message);
      }
    }

    // Silent API - no reload, for optimistic updates
    async function apiSilent(payload) {
      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      if (!result.success) throw new Error(result.error);
      return result;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function render() {
      renderStats();
      renderFilters();
      renderSystems();
      renderProgress();
      renderFocus();
      renderAttention();
    }

    function renderStats() {
      const systems = data.systems;
      const features = data.features;
      document.getElementById('statSystems').textContent = systems.length;
      document.getElementById('statFeatures').textContent = features.length;
      document.getElementById('statActive').textContent = features.filter(f => f.Status === 'Active').length;
    }

    function renderFilters() {
      const categories = ['all', ...new Set(data.systems.map(s => s.Category))];
      document.getElementById('filters').innerHTML = categories.map(c => `
        <button class="filter-btn ${selectedCategory === c ? 'active' : ''}" onclick="setFilter('${c}')">
          ${c === 'all' ? 'All' : (categoryIcons[c] || '') + ' ' + c}
        </button>
      `).join('');
    }

    function setFilter(cat) {
      selectedCategory = cat;
      renderFilters();
      renderSystems();
    }

    function renderSystems() {
      let systems = data.systems;
      
      if (selectedCategory !== 'all') {
        systems = systems.filter(s => s.Category === selectedCategory);
      }
      
      if (searchQuery) {
        systems = systems.filter(s => {
          const nameMatch = s.Name.toLowerCase().includes(searchQuery);
          const featureMatch = data.features.some(f => 
            f.SystemID === s.ID && f.Name.toLowerCase().includes(searchQuery)
          );
          return nameMatch || featureMatch;
        });
      }

      systems.sort((a, b) => (a.Priority || 99) - (b.Priority || 99));

      document.getElementById('systemsList').innerHTML = systems.map(s => {
        const features = data.features.filter(f => f.SystemID === s.ID);
        const activeFeatures = features.filter(f => f.Status === 'Active');
        const progress = features.length > 0 
          ? Math.round(features.reduce((sum, f) => sum + f.Level, 0) / (features.length * 5) * 100)
          : 0;
        const isExpanded = expandedSystems.has(s.ID);
        const color = categoryColors[s.Category] || '#666';

        return `
          <div class="system-card ${isExpanded ? 'expanded' : ''}" data-id="${s.ID}">
            <div class="system-header" onclick="toggleSystem('${s.ID}')">
              <div class="system-icon" style="background:${color}20; color:${color}">
                ${categoryIcons[s.Category] || 'â—‹'}
              </div>
              <div class="system-info">
                <div class="system-title-row">
                  <span class="system-name">${s.Name}</span>
                  <button class="system-edit-btn" onclick="editSystemName(event,'${s.ID}','${s.Name}')">âœ</button>
                </div>
                <div class="system-meta-row">
                  <span class="system-badge ${s.Status.toLowerCase()}" 
                    onclick="cycleStatus(event,'${s.ID}','${s.Status}')">${s.Status}</span>
                  <span class="system-feature-count">${activeFeatures.length}/${features.length}</span>
                </div>
              </div>
              <div class="system-progress-bar">
                <div class="system-progress-fill" style="width:${progress}%; background:${color}"></div>
              </div>
              <div class="system-progress-text">${progress}%</div>
              <div class="system-chevron">â–¼</div>
            </div>
            <div class="system-features">
              ${features.map(f => renderFeature(f)).join('')}
              <div class="add-feature-row">
                <input type="text" class="add-feature-input" id="input-${s.ID}" 
                  placeholder="Add feature..." onkeydown="if(event.key==='Enter')addFeature('${s.ID}')">
                <button class="add-feature-btn" onclick="addFeature('${s.ID}')">Add</button>
              </div>
              <div class="delete-system-row">
                <button class="delete-system-btn" onclick="deleteSystem('${s.ID}')">Delete System</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderFeature(f) {
      const isActive = f.Status === 'Active';
      return `
        <div class="feature-row" data-id="${f.ID}">
          <div class="feature-status ${isActive ? 'active' : 'planned'}" 
            onclick="toggleFeatureStatus('${f.ID}')" title="${isActive ? 'Active' : 'Planned'}"></div>
          <div class="feature-name-wrap">
            <span class="feature-name ${isActive ? '' : 'planned'}">${f.Name}</span>
            <button class="feature-edit-btn" onclick="editFeatureName(event,'${f.ID}','${f.Name}')">âœ</button>
          </div>
          <div class="feature-level">
            <span class="feature-level-text">Lv ${f.Level}</span>
            <div class="level-dots">
              ${[1,2,3,4,5].map(i => `
                <div class="level-dot ${i <= f.Level ? 'filled' : ''}" 
                  onclick="setFeatureLevel('${f.ID}',${i})" title="Level ${i}"></div>
              `).join('')}
            </div>
          </div>
          <button class="feature-delete" onclick="deleteFeature('${f.ID}')">Ã—</button>
        </div>
      `;
    }

    function renderProgress() {
      const features = data.features;
      const progress = features.length > 0 
        ? Math.round(features.reduce((sum, f) => sum + f.Level, 0) / (features.length * 5) * 100)
        : 0;

      document.getElementById('progressValue').textContent = progress + '%';
      
      const circumference = 2 * Math.PI * 26;
      document.getElementById('progressRing').style.strokeDashoffset = 
        circumference - (progress / 100) * circumference;

      // Momentum from history
      let history = [];
      try { history = JSON.parse(localStorage.getItem('lifeOsProgressHistory') || '[]'); } catch(e) {}
      
      const today = new Date().toISOString().split('T')[0];
      const lastEntry = history[history.length - 1];
      if (!lastEntry || lastEntry.date !== today) {
        history.push({ date: today, progress });
        if (history.length > 56) history = history.slice(-56);
      } else {
        lastEntry.progress = progress;
      }
      localStorage.setItem('lifeOsProgressHistory', JSON.stringify(history));

      // Calculate delta
      if (history.length >= 8) {
        const weekAgo = history[history.length - 8]?.progress || progress;
        const delta = progress - weekAgo;
        const deltaEl = document.getElementById('progressDelta');
        deltaEl.textContent = (delta >= 0 ? '+' : '') + delta + '%';
        deltaEl.className = 'progress-delta ' + (delta > 0 ? 'positive' : delta < 0 ? 'negative' : 'neutral');
        document.getElementById('progressSub').textContent = delta >= 0 ? 'Keep it up!' : 'Time to focus';
      }
    }

    function renderFocus() {
      const focus = JSON.parse(localStorage.getItem('lifeOsWeeklyFocus') || 'null');
      const section = document.getElementById('focusSection');
      
      if (!focus || !focus.systems || focus.systems.length === 0) {
        section.style.display = 'none';
        return;
      }

      // Check if expired (> 7 days)
      const focusDate = new Date(focus.date);
      const now = new Date();
      if ((now - focusDate) / (1000*60*60*24) > 7) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      document.getElementById('focusList').innerHTML = focus.systems.map(id => {
        const system = data.systems.find(s => s.ID === id);
        if (!system) return '';
        const features = data.features.filter(f => f.SystemID === id);
        const progress = features.length > 0 
          ? Math.round(features.reduce((sum, f) => sum + f.Level, 0) / (features.length * 5) * 100)
          : 0;
        return `
          <div class="focus-item">
            <span class="focus-icon">${categoryIcons[system.Category] || 'â—‹'}</span>
            <span class="focus-name">${system.Name}</span>
            <span class="focus-progress">${progress}%</span>
          </div>
        `;
      }).join('');
    }

    function renderAttention() {
      const section = document.getElementById('attentionSection');
      const needs = data.systems.filter(s => 
        s.Status === 'Struggle' || s.Status === 'Rework' ||
        data.features.filter(f => f.SystemID === s.ID && f.Status === 'Active').length === 0
      ).slice(0, 3);

      if (needs.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      document.getElementById('attentionList').innerHTML = needs.map((s, i) => `
        <div class="attention-item">
          <span class="attention-rank">#${i + 1}</span>
          <span class="attention-name">${s.Name}</span>
          <span class="attention-badge">${s.Status}</span>
        </div>
      `).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NORTH STAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderNorthStar() {
      const saved = localStorage.getItem('lifeOsNorthStar') || '';
      const el = document.getElementById('northStarText');
      el.textContent = saved ? '"' + saved + '"' : 'Define your purpose...';
      el.classList.toggle('empty', !saved);
    }

    function editNorthStar() {
      const current = localStorage.getItem('lifeOsNorthStar') || '';
      const newValue = prompt('Your North Star â€“ Why are you doing all this?', current);
      if (newValue !== null) {
        localStorage.setItem('lifeOsNorthStar', newValue.trim());
        renderNorthStar();
        toast('North Star saved');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // QUARTERLY GOALS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderQuarterlyGoals() {
      const quarter = Math.floor(new Date().getMonth() / 3) + 1;
      const year = new Date().getFullYear();
      const key = `${year}-Q${quarter}`;
      
      document.getElementById('currentQuarter').textContent = quarter;
      
      let goals = [];
      try {
        goals = JSON.parse(localStorage.getItem('lifeOsQuarterlyGoals') || '[]')
          .filter(g => g.quarter === key);
      } catch(e) {}

      document.getElementById('goalsList').innerHTML = goals.length > 0
        ? goals.map((g, i) => `
            <div class="goal-item" onclick="editGoal(${i})">
              <span class="goal-num">${i + 1}</span>
              <span class="goal-text">${g.text}</span>
            </div>
          `).join('')
        : '';
      
      if (goals.length < 3) {
        document.getElementById('goalsList').innerHTML += `
          <div class="goal-add" onclick="addGoal()">+ Add Goal</div>
        `;
      }
    }

    function addGoal() {
      const quarter = Math.floor(new Date().getMonth() / 3) + 1;
      const year = new Date().getFullYear();
      const key = `${year}-Q${quarter}`;
      
      const text = prompt('New Quarterly Goal:');
      if (!text || !text.trim()) return;

      let goals = [];
      try { goals = JSON.parse(localStorage.getItem('lifeOsQuarterlyGoals') || '[]'); } catch(e) {}
      
      const current = goals.filter(g => g.quarter === key);
      if (current.length >= 3) return toast('Max 3 goals per quarter');

      goals.push({ quarter: key, text: text.trim() });
      localStorage.setItem('lifeOsQuarterlyGoals', JSON.stringify(goals));
      renderQuarterlyGoals();
      toast('Goal added');
    }

    function editGoal(idx) {
      const quarter = Math.floor(new Date().getMonth() / 3) + 1;
      const year = new Date().getFullYear();
      const key = `${year}-Q${quarter}`;

      let goals = [];
      try { goals = JSON.parse(localStorage.getItem('lifeOsQuarterlyGoals') || '[]'); } catch(e) {}
      
      const current = goals.filter(g => g.quarter === key);
      const goal = current[idx];
      if (!goal) return;

      const action = prompt(`Edit goal:\n"${goal.text}"\n\nEnter new text, or type DELETE:`, goal.text);
      if (action === null) return;

      if (action.toUpperCase() === 'DELETE') {
        const globalIdx = goals.findIndex(g => g.quarter === key && g.text === goal.text);
        if (globalIdx > -1) goals.splice(globalIdx, 1);
        toast('Goal deleted');
      } else if (action.trim()) {
        const globalIdx = goals.findIndex(g => g.quarter === key && g.text === goal.text);
        if (globalIdx > -1) goals[globalIdx].text = action.trim();
        toast('Goal updated');
      }

      localStorage.setItem('lifeOsQuarterlyGoals', JSON.stringify(goals));
      renderQuarterlyGoals();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SYSTEM ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleSystem(id) {
      if (expandedSystems.has(id)) {
        expandedSystems.delete(id);
      } else {
        expandedSystems.add(id);
      }
      renderSystems();
    }

    function cycleStatus(e, id, current) {
      e.stopPropagation();
      const idx = statusOrder.indexOf(current);
      const next = statusOrder[(idx + 1) % statusOrder.length];
      
      // Optimistic update
      const system = data.systems.find(s => s.ID === id);
      if (system) {
        system.Status = next;
        renderSystems();
        render();
        apiSilent({ action: 'updateSystemStatus', systemId: id, status: next })
          .catch(() => { system.Status = current; render(); toast('Sync failed'); });
      }
    }

    function editSystemName(e, id, current) {
      e.stopPropagation();
      const newName = prompt('Rename system:', current);
      if (!newName || newName === current) return;
      
      const system = data.systems.find(s => s.ID === id);
      if (system) {
        system.Name = newName;
        renderSystems();
        apiSilent({ action: 'updateSystemName', systemId: id, name: newName })
          .catch(() => { system.Name = current; renderSystems(); toast('Sync failed'); });
      }
    }

    function deleteSystem(id) {
      if (!confirm('Delete this system and all its features?')) return;
      apiPost({ action: 'deleteSystem', systemId: id });
    }

    function openAddSystemModal() {
      document.getElementById('newSystemName').value = '';
      document.getElementById('addSystemModal').classList.add('visible');
      document.getElementById('newSystemName').focus();
    }

    function addSystem() {
      const name = document.getElementById('newSystemName').value.trim();
      const category = document.getElementById('newSystemCategory').value;
      if (!name) return toast('Enter a name');
      
      closeModal('addSystemModal');
      apiPost({ action: 'addSystem', name, category });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FEATURE ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleFeatureStatus(id) {
      const feature = data.features.find(f => f.ID === id);
      if (!feature) return;
      
      const newStatus = feature.Status === 'Active' ? 'Planned' : 'Active';
      feature.Status = newStatus;
      renderSystems();
      
      apiSilent({ action: 'updateFeatureStatus', featureId: id, status: newStatus })
        .catch(() => { 
          feature.Status = feature.Status === 'Active' ? 'Planned' : 'Active'; 
          renderSystems(); 
          toast('Sync failed'); 
        });
    }

    function setFeatureLevel(id, level) {
      const feature = data.features.find(f => f.ID === id);
      if (!feature) return;
      
      const oldLevel = feature.Level;
      feature.Level = level;
      renderSystems();
      renderProgress();
      
      apiSilent({ action: 'updateFeatureLevel', featureId: id, level })
        .catch(() => { 
          feature.Level = oldLevel; 
          renderSystems(); 
          renderProgress();
          toast('Sync failed'); 
        });
    }

    function editFeatureName(e, id, current) {
      e.stopPropagation();
      const newName = prompt('Rename feature:', current);
      if (!newName || newName === current) return;
      
      const feature = data.features.find(f => f.ID === id);
      if (feature) {
        feature.Name = newName;
        renderSystems();
        apiSilent({ action: 'updateFeatureName', featureId: id, name: newName })
          .catch(() => { feature.Name = current; renderSystems(); toast('Sync failed'); });
      }
    }

    function addFeature(systemId) {
      const input = document.getElementById('input-' + systemId);
      const name = input.value.trim();
      if (!name) return;
      
      input.value = '';
      apiPost({ action: 'addFeature', systemId, name });
    }

    function deleteFeature(id) {
      apiPost({ action: 'deleteFeature', featureId: id });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WEEKLY REVIEW
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openReviewModal() {
      document.getElementById('reviewWins').value = '';
      document.getElementById('reviewStruggles').value = '';
      document.getElementById('reviewEnergy').value = '';
      
      // Populate system dropdowns
      [1, 2, 3].forEach(n => {
        const select = document.getElementById('reviewFocus' + n);
        select.innerHTML = '<option value="">Select system...</option>' +
          data.systems.map(s => `<option value="${s.ID}">${s.Name}</option>`).join('');
      });
      
      document.getElementById('reviewModal').classList.add('visible');
    }

    function submitReview() {
      const focus = [
        document.getElementById('reviewFocus1').value,
        document.getElementById('reviewFocus2').value,
        document.getElementById('reviewFocus3').value
      ].filter(Boolean);

      localStorage.setItem('lifeOsWeeklyFocus', JSON.stringify({
        date: new Date().toISOString(),
        systems: focus
      }));

      // Save review to sheet
      apiPost({
        action: 'addWeeklyReview',
        wins: document.getElementById('reviewWins').value,
        struggles: document.getElementById('reviewStruggles').value,
        energy: document.getElementById('reviewEnergy').value,
        focus: focus.join(','),
        progress: document.getElementById('progressValue').textContent
      });

      closeModal('reviewModal');
      renderFocus();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMMAND PALETTE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let commandSelected = 0;
    let commandItems = [];

    function openCommandPalette() {
      document.getElementById('commandOverlay').classList.add('visible');
      document.getElementById('commandInput').value = '';
      document.getElementById('commandInput').focus();
      commandSelected = 0;
      renderCommandResults('');
    }

    function closeCommandPalette() {
      document.getElementById('commandOverlay').classList.remove('visible');
    }

    function handleCommandInput(e) {
      commandSelected = 0;
      renderCommandResults(e.target.value.toLowerCase());
    }

    function handleCommandKeydown(e) {
      if (e.key === 'Escape') closeCommandPalette();
      else if (e.key === 'ArrowDown') {
        e.preventDefault();
        commandSelected = Math.min(commandSelected + 1, commandItems.length - 1);
        updateCommandSelection();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        commandSelected = Math.max(commandSelected - 1, 0);
        updateCommandSelection();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (commandItems[commandSelected]) commandItems[commandSelected].action();
      }
    }

    function renderCommandResults(query) {
      commandItems = [];
      let html = '';

      // Actions
      const actions = [
        { icon: 'ğŸ“‹', text: 'Weekly Review', hint: 'W', action: () => { closeCommandPalette(); openReviewModal(); }},
        { icon: 'â•', text: 'Add System', hint: 'N', action: () => { closeCommandPalette(); openAddSystemModal(); }},
        { icon: 'â†»', text: 'Refresh', hint: 'R', action: () => { closeCommandPalette(); loadData(); }},
        { icon: 'â˜…', text: 'Edit North Star', action: () => { closeCommandPalette(); editNorthStar(); }},
        { icon: 'â—†', text: 'Add Goal', action: () => { closeCommandPalette(); addGoal(); }},
      ].filter(a => a.text.toLowerCase().includes(query) || (a.hint && a.hint.toLowerCase() === query));

      if (actions.length) {
        html += '<div class="command-group"><div class="command-group-label">Actions</div>';
        actions.forEach(a => {
          commandItems.push(a);
          html += `<div class="command-item ${commandItems.length - 1 === commandSelected ? 'selected' : ''}" 
            onclick="commandItems[${commandItems.length - 1}].action()">
            <span class="command-item-icon">${a.icon}</span>
            <span class="command-item-text">${a.text}</span>
            ${a.hint ? `<span class="command-item-hint">${a.hint}</span>` : ''}
          </div>`;
        });
        html += '</div>';
      }

      // Systems
      const systems = data.systems.filter(s => s.Name.toLowerCase().includes(query)).slice(0, 5);
      if (systems.length) {
        html += '<div class="command-group"><div class="command-group-label">Systems</div>';
        systems.forEach(s => {
          const item = {
            icon: categoryIcons[s.Category] || 'â—‹',
            text: s.Name,
            hint: s.Status,
            action: () => {
              closeCommandPalette();
              expandedSystems.add(s.ID);
              selectedCategory = 'all';
              renderFilters();
              renderSystems();
              setTimeout(() => {
                document.querySelector(`.system-card[data-id="${s.ID}"]`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 100);
            }
          };
          commandItems.push(item);
          html += `<div class="command-item ${commandItems.length - 1 === commandSelected ? 'selected' : ''}" 
            onclick="commandItems[${commandItems.length - 1}].action()">
            <span class="command-item-icon">${item.icon}</span>
            <span class="command-item-text">${item.text}</span>
            <span class="command-item-hint">${item.hint}</span>
          </div>`;
        });
        html += '</div>';
      }

      if (!commandItems.length) {
        html = '<div style="padding:24px;text-align:center;color:var(--text-tertiary)">No results</div>';
      }

      document.getElementById('commandResults').innerHTML = html;
    }

    function updateCommandSelection() {
      document.querySelectorAll('.command-item').forEach((el, i) => {
        el.classList.toggle('selected', i === commandSelected);
      });
      document.querySelectorAll('.command-item')[commandSelected]?.scrollIntoView({ block: 'nearest' });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SEARCH & KEYBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function handleSearch(e) {
      searchQuery = e.target.value.toLowerCase().trim();
      renderSystems();
    }

    document.addEventListener('keydown', e => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openCommandPalette();
        return;
      }

      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        if (e.key === 'Escape') e.target.blur();
        return;
      }

      if (e.key === '/') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
      } else if (e.key === 'r') loadData();
      else if (e.key === 'n') openAddSystemModal();
      else if (e.key === 'w') openReviewModal();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function closeModal(id) {
      document.getElementById(id).classList.remove('visible');
    }

    function toast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('visible');
      setTimeout(() => el.classList.remove('visible'), 2500);
    }

    // Start
    init();
  </script>
</body>
</html>
